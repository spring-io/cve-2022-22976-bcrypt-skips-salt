package org.springframework.security.bcrypt.sample;

import java.util.Map;

import org.springframework.security.bcrypt.check.VulnerabilityCheck;

public class UpdateCommand {
	private Map<Long, String> passwords;
	private final ConsoleUpdateView view;

	public UpdateCommand(Map<Long, String> passwords,
						 ConsoleUpdateView view) {
		this.passwords = passwords;
		this.view = view;
	}

	public void run() {
		new Run().run();
	}

	private class Run {
		int recordsNeedingUpdating = 0;
		int recordsUpdated = 0;

		void run() {
			view.updateStart();
			passwords.entrySet().stream().filter((entry) -> VulnerabilityCheck.isHashVulnerable(entry.getValue()))
					.forEach((entry) -> {
						this.recordsNeedingUpdating++;
						passwords.put(entry.getKey(), VulnerabilityCheck.correctHash(entry.getValue()));
						this.recordsUpdated++;
					});
			view.updateComplete(this.recordsNeedingUpdating, this.recordsUpdated);
		}
	}
}
