package org.springframework.security.bcrypt.sample;

import java.util.Map;

import org.junit.jupiter.api.Test;
import org.mockito.ArgumentCaptor;

import static org.assertj.core.api.Assertions.assertThat;
import static org.mockito.Mockito.spy;
import static org.mockito.Mockito.verify;

public class UpdateCommandTests {
	@Test
	void givenBadHashesWithPrefixThenUpdates() {
		ConsoleUpdateView view = spy(new ConsoleUpdateView());
		Map<Long, String> hashes = TestHashes.withPrefix();
		UpdateCommand command = new UpdateCommand(hashes, view);
		command.run();
		ArgumentCaptor<Integer> badRecordsCount = ArgumentCaptor.forClass(Integer.class);
		ArgumentCaptor<Integer> badRecordsUpdated = ArgumentCaptor.forClass(Integer.class);
		verify(view).updateComplete(badRecordsCount.capture(), badRecordsUpdated.capture());
		assertThat(badRecordsCount.getValue()).isEqualTo(badRecordsUpdated.getValue());
		verifyNoUpdatesNeeded(hashes);
	}

	@Test
	void givenBadHashesWithoutPrefixThenUpdates() {
		ConsoleUpdateView view = spy(new ConsoleUpdateView());
		Map<Long, String> hashes = TestHashes.withoutPrefix();
		UpdateCommand command = new UpdateCommand(hashes, view);
		command.run();
		ArgumentCaptor<Integer> badRecordsCount = ArgumentCaptor.forClass(Integer.class);
		ArgumentCaptor<Integer> badRecordsUpdated = ArgumentCaptor.forClass(Integer.class);
		verify(view).updateComplete(badRecordsCount.capture(), badRecordsUpdated.capture());
		assertThat(badRecordsCount.getValue()).isEqualTo(badRecordsUpdated.getValue());
		verifyNoUpdatesNeeded(hashes);
	}

	@Test
	void givenOkayHashesThenUpdateComplete() {
		ConsoleUpdateView view = spy(new ConsoleUpdateView());
		Map<Long, String> hashes = TestHashes.okay();
		UpdateCommand command = new UpdateCommand(hashes, view);
		command.run();
		ArgumentCaptor<Integer> badRecordsCount = ArgumentCaptor.forClass(Integer.class);
		ArgumentCaptor<Integer> badRecordsUpdated = ArgumentCaptor.forClass(Integer.class);
		verify(view).updateComplete(badRecordsCount.capture(), badRecordsUpdated.capture());
		assertThat(badRecordsCount.getValue()).isEqualTo(badRecordsUpdated.getValue()).isEqualTo(0);
		verifyNoUpdatesNeeded(hashes);
	}

	@Test
	void givenBadHashesThenUpdatesRegardlessOfPrefix() {
		ConsoleUpdateView view = spy(new ConsoleUpdateView());
		Map<Long, String> hashes = TestHashes.hashes();
		UpdateCommand command = new UpdateCommand(hashes, view);
		command.run();
		ArgumentCaptor<Integer> badRecordsCount = ArgumentCaptor.forClass(Integer.class);
		ArgumentCaptor<Integer> badRecordsUpdated = ArgumentCaptor.forClass(Integer.class);
		verify(view).updateComplete(badRecordsCount.capture(), badRecordsUpdated.capture());
		assertThat(badRecordsCount.getValue()).isEqualTo(badRecordsUpdated.getValue());
		verifyNoUpdatesNeeded(hashes);
	}

	private void verifyNoUpdatesNeeded(Map<Long, String> hashes) {
		ConsoleCheckView view = spy(new ConsoleCheckView());
		CheckCommand command = new CheckCommand(hashes, view);
		command.run();
		verify(view).noUpdatesNeeded();
	}
}
